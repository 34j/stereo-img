<!DOCTYPE html>
<html>
<head>
  <title>&lt;stereo-img&gt; demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script type="importmap">
    {
      "imports": {
        "exifr": "https://cdn.skypack.dev/pin/exifr@v7.1.3-Bxn3dmuljZ8rRmNteMgs/mode=imports,min/optimized/exifr.js",
        "three": "https://cdn.skypack.dev/three@0.133.1",
        "three/": "https://cdn.skypack.dev/three@0.133.1/"
      }
    }
  </script>

  <style>
    img, stereo-img {
      width: 600px;
      height: 400px;
    }
  </style>

  <script type="module" src="stereo-img.js"></script>

</head>

<body id='dropbox'>

  <header>
    <h1>&lt;stereo-img&gt; demo</h1>
    <p>&lt;stereo-img&gt; is a web component to display stereographic pictures on web pages and in VR. It supports various stereo picture types: VR180, left-right, and anaglyph.</p>
    <p>
      <label for="input">Drag and drop or select your stereo pictures:</label>
      <input type="file" id="input" multiple accept="image/*">
    </p>
    <p>
      <label for="examples">Or try these demos:</label>
      <select id="examples">
        <option value='{"src": "examples/vr180-lenovo-mirage.vr.jpg", "type": "vr180"}'>          VR180</option>
        <option value='{"src": "examples/GOPR0.left-right.jpg", "type": "left-right"}'>           Left-right stereo Go Pro</option>
        <option value='{"src": "examples/stereograph.left-right.jpg", "type": "left-right"}'>     Left-right stereograph 1901</option>
        <option value='{"src": "examples/wikipedia.anaglyph.jpg", "type": "anaglyph"}'>           Anaglyph</option>
      </select>
    </p>
  </header>

  <main>
    <p>&lt;stereo-img&gt; element:</p>
    <stereo-img src="examples/vr180-lenovo-mirage.vr.jpg" type="vr180"></stereo-img>
    <button id="previous" >Previous</button> <button id="next">Next</button>
    
    <p>Just for comparison, here is the same in a regular &lt;img&gt; element:</p>
    <img src="examples/vr180-lenovo-mirage.vr.jpg">
  </main>

  <script>
    // On dropdown item selection, update <stereo-img>
    const examples = document.getElementById('examples');
    examples.addEventListener('change', (e) => {
      const { src, type } = JSON.parse(e.target.value);
      const stereoImg = document.querySelector('stereo-img');
      stereoImg.src = src;
      stereoImg.type = type;

      const img = document.querySelector('img');
      img.src = src;
    });

    function previous() {
      const index = examples.selectedIndex;
      if (index > 0) {
        examples.selectedIndex = index - 1;
        examples.dispatchEvent(new Event('change'));
      }
    }

    function next() {
      const index = examples.selectedIndex;
      if (index < examples.options.length - 1) {
        examples.selectedIndex = index + 1;
        examples.dispatchEvent(new Event('change'));
      }
    }

    document.getElementById('previous').addEventListener('click', previous);
    document.getElementById('next').addEventListener('click', next);

    // listen for arrow keypress and go to previous / next option in dropdown examples
    document.addEventListener('keydown', (e) => {
      if (e.keyCode == 37 || e.keyCode === 38) {
        previous();
      } else if (e.keyCode == 39 || e.keyCode === 40) {
        next();
      }
    });

    // Add selected files to dropdown
    function handleFiles(files) {
      for (let i = 0; i < files.length; i++) {
        let file = files[i];
        
        if (!file.type.startsWith('image/')){ continue }
        
        let reader = new FileReader();
        reader.onload = e => { processFile(e.target.result, file.name); };
        reader.readAsDataURL(file);
      }
    }

    // Add a URL to the dropdown
    function processFile(url, name) {
      const newOption = document.createElement("option");
      newOption.value = JSON.stringify({ src: url });
      newOption.text = name;
      examples.appendChild(newOption);
      examples.selectedIndex = examples.options.length - 1;
      examples.dispatchEvent(new Event('change'));
    }

    document.getElementById("input").addEventListener("change", (e) => {
      handleFiles(e.target.files);
    }, false);

    // Drag and drop
    const dropzone = document.getElementById("dropbox");
    dropzone.ondragover = dropzone.ondragenter = (e) => {
      e.stopPropagation();
      e.preventDefault();
    }
    dropzone.ondrop = (e) => {
      e.stopPropagation();
      e.preventDefault();
      handleFiles(e.dataTransfer.files);
    }
  </script>

</body>

</html>